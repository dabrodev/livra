datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  createdAt DateTime  @default(now())
  personas  Persona[]
  role      String    @default("USER") // "USER", "ADMIN", "CREATOR"
}

model Persona {
  userId          String
  id              String  @id @default(uuid())
  type            String  @default("INFLUENCER") // "INFLUENCER", "ASSISTANT", etc.
  name            String
  country         String // Display name (e.g., "Poland")
  countryCode     String? // ISO 3166-1 alpha-2 (e.g., "PL") - optional during migration
  city            String // Normalized English name (e.g., "Warsaw")
  cityLocal       String? // Local language name (e.g., "Warszawa")
  neighborhood    String?
  apartmentStyle  String
  currentBalance  Float   @default(5000)
  personalityVibe String // e.g., "Minimalist Glam", "Streetwear Rebel"
  gender          String  @default("female") // "male" or "female"
  isActive        Boolean @default(false)
  isPublic        Boolean @default(true)

  // Appearance
  hairColor  String   @default("brown") // blonde, brunette, red, black, auburn, gray
  hairStyle  String   @default("long") // long, short, medium, curly, straight, wavy
  eyeColor   String   @default("brown") // blue, green, brown, hazel, gray
  skinTone   String   @default("medium") // light, fair, medium, tan, olive, dark
  lipStyle   String   @default("natural") // full, thin, natural
  facialHair String   @default("none") // none, stubble, beard, goatee, mustache (for males)
  features   String[] // freckles, glasses, dimples, beauty-mark, etc.
  bodyHeight String   @default("average") // petite, average, tall
  bodyType   String   @default("slim") // slim, athletic, curvy, plus-size, muscular, stocky

  // Clothing Style Preferences
  clothingStyle  String   @default("casual") // casual, sporty, elegant, streetwear, bohemian
  bottomwear     String[] // jeans, skirts, shorts, leggings, dresses
  footwear       String[] // sneakers, heels, barefoot, slippers, boots
  signatureItems String[] // always tights, oversized sweaters, accessories, etc.

  // The 14-Slot Asset Management
  faceReferences String[] // URLs to master face images
  roomReferences String[] // URLs to influencer's apartment shots

  posts              Post[]
  memories           Memory[]
  lifecycleStartedAt DateTime? // Null = never started, set on first start

  // Real-time Activity Tracking
  lifecycleStatus   String    @default("new") // "new" | "running" | "paused"
  currentActivity   String? // "sleeping" | "planning" | "creating" | "active" | "resting"
  activityDetails   String? // Human-readable description e.g., "Morning Coffee at Caf√© Luna"
  activityStartedAt DateTime? // When current activity started

  // Daily Outfit (persists through the day, changes each morning)
  dailyOutfit     Json? // { top, bottom, footwear, accessories, tightsColor }
  dailyOutfitDate DateTime? // Date when outfit was selected (to reset next day)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
}

model Post {
  id         String   @id @default(uuid())
  personaId  String
  persona    Persona  @relation(fields: [personaId], references: [id])
  type       String // "IMAGE" or "VIDEO"
  contentUrl String
  caption    String
  prompt     String?
  postedAt   DateTime @default(now())

  memoryId   String?
  memory     Memory?  @relation(fields: [memoryId], references: [id])
}

model Memory {
  id          String   @id @default(uuid())
  personaId   String
  persona     Persona  @relation(fields: [personaId], references: [id])
  description String // Short-term memory of recent events
  importance  Int      @default(1)
  createdAt   DateTime @default(now())
  
  posts       Post[]
}

// Global avatar library for reuse across influencers
model AvatarLibrary {
  id     String  @id @default(uuid())
  url    String // URL to the stored avatar image
  gender String? // "male" or "female"

  // Appearance traits for filtering
  hairColor  String?
  hairStyle  String?
  eyeColor   String?
  skinTone   String?
  lipStyle   String?
  features   String[]
  bodyHeight String?
  bodyType   String?

  // Usage tracking
  usedBy    String[] // IDs of personas using this avatar
  createdAt DateTime @default(now())
}

// Optimization for SerpAPI usage (6 hour cache)
model TrendsCache {
  id          String   @id @default(uuid())
  category    String
  countryCode String
  data        Json     // Stores the full TrendsResult object
  
  updatedAt   DateTime @updatedAt // Last fetch time
  createdAt   DateTime @default(now())

  @@unique([category, countryCode]) // One cache entry per category/country
}
